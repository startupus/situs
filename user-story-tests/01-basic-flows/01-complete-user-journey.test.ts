/**
 * üéØ –û–°–ù–û–í–ù–û–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ô –°–¶–ï–ù–ê–†–ò–ô
 * 
 * –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
 * 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å –Ω–µ–≤–µ—Ä–Ω—ã–º email
 * 2. –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏
 * 3. –°–º–µ–Ω–∞ email –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
 * 4. –ü–æ–ª—É—á–µ–Ω–∏–µ 500 –ú–æ–Ω–µ—Ç—É—Å –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
 * 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AI —á–µ—Ä–µ–∑ —á–∞—Ç-—Å–µ—Ä–≤–∏—Å (5 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ 100 –ú–æ–Ω–µ—Ç—É—Å)
 * 6. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
 * 7. –ü–æ–∫—É–ø–∫–∞ 1000 –ú–æ–Ω–µ—Ç—É—Å —á–µ—Ä–µ–∑ –ÆMoney
 * 8. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π AI –∑–∞–ø—Ä–æ—Å
 * 9. –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ - –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–≥–∞
 * 10. –ü–æ–ª—É—á–µ–Ω–∏–µ 1000 –ú–æ–Ω–µ—Ç—É—Å –∑–∞ –¥—Ä—É–≥–∞
 */

// –ò—Å–ø–æ–ª—å–∑—É–µ–º Node.js assert –¥–ª—è –±–∞–∑–æ–≤—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
import { strict as assert } from 'assert';

// –ü—Ä–æ—Å—Ç—ã–µ —Ö–µ–ª–ø–µ—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
const describe = (name: string, fn: () => void) => {
  console.log(`\nüß™ ${name}`);
  fn();
};

const it = (name: string, fn: () => Promise<void>) => {
  console.log(`  üìù ${name}`);
  return fn();
};

const expect = (actual: any) => ({
  toBe: (expected: any) => assert.strictEqual(actual, expected),
  toBeGreaterThan: (expected: any) => assert.ok(actual > expected),
  toBeGreaterThanOrEqual: (expected: any) => assert.ok(actual >= expected),
  toBeDefined: () => assert.ok(actual !== undefined),
  toContain: (expected: any) => assert.ok(actual.includes(expected))
});

const beforeEach = (fn: () => Promise<void>) => {
  // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
};

const afterEach = (fn: () => Promise<void>) => {
  // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏  
};

describe('üéØ –ü–æ–ª–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π', () => {
  let testRunner: any;

  beforeEach(async () => {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    console.log('üîÑ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è...');
  });

  afterEach(async () => {
    // –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤
    console.log('üßπ –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è...');
  });

  it('–û—Å–Ω–æ–≤–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π journey –æ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã', async () => {
    console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π...');

    // ========================================
    // –≠–¢–ê–ü 1: –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –° –ù–ï–í–ï–†–ù–´–ú EMAIL
    // ========================================
    console.log('\nüìù –≠–¢–ê–ü 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å –Ω–µ–≤–µ—Ä–Ω—ã–º email');
    
    const user1Data = {
      name: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤',
      email: 'ivan@nonexistent-domain.ru', // –ù–µ–≤–µ—Ä–Ω—ã–π email
      password: 'SecurePass123!',
      phone: '+79991234567'
    };

    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è
    const registrationResult = await fetch('/api/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(user1Data)
    });

    expect(registrationResult.ok).toBe(true);
    const regData = await registrationResult.json();
    expect(regData.success).toBe(true);
    expect(regData.user.emailVerified).toBe(false);
    
    const user1Id = regData.user.id;
    console.log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${user1Id}`);

    // ========================================
    // –≠–¢–ê–ü 2: –ü–û–ü–´–¢–ö–ê –í–•–û–î–ê –ë–ï–ó –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø
    // ========================================
    console.log('\nüîê –≠–¢–ê–ü 2: –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email');

    const loginAttempt = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: user1Data.email,
        password: user1Data.password
      })
    });

    const loginData = await loginAttempt.json();
    expect(loginData.success).toBe(false);
    expect(loginData.error).toBe('EMAIL_NOT_VERIFIED');
    expect(loginData.message).toContain('–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å email');
    
    console.log('‚ùå –í—Ö–æ–¥ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email');

    // ========================================
    // –≠–¢–ê–ü 3: –°–ú–ï–ù–ê EMAIL –ò –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï
    // ========================================
    console.log('\nüìß –≠–¢–ê–ü 3: –°–º–µ–Ω–∞ email –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ');

    const correctEmail = 'ivan.petrov@gmail.com';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º email
    const emailUpdateResult = await fetch(`/api/auth/update-email`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: user1Id,
        newEmail: correctEmail
      })
    });

    expect(emailUpdateResult.ok).toBe(true);
    console.log(`üìß Email –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞: ${correctEmail}`);

    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–≤ —Ç–µ—Å—Ç–∞—Ö —Å–∏–º—É–ª–∏—Ä—É–µ–º)
    const verificationCode = '123456'; // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–∑ email
    
    const verifyResult = await fetch('/api/auth/verify-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: user1Id,
        code: verificationCode
      })
    });

    expect(verifyResult.ok).toBe(true);
    console.log('‚úÖ Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ');

    // –¢–µ–ø–µ—Ä—å –º–æ–∂–µ–º –≤–æ–π—Ç–∏
    const successfulLogin = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: correctEmail,
        password: user1Data.password
      })
    });

    const loginSuccess = await successfulLogin.json();
    expect(loginSuccess.success).toBe(true);
    
    const authToken = loginSuccess.token;
    console.log('üîì –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É');

    // ========================================
    // –≠–¢–ê–ü 4: –ü–†–û–í–ï–†–ö–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–û–ù–ù–û–ì–û –ë–û–ù–£–°–ê
    // ========================================
    console.log('\nüí∞ –≠–¢–ê–ü 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è 500 –ú–æ–Ω–µ—Ç—É—Å –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é');

    const balanceResult = await fetch(`/api/billing/balance/${user1Id}`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });

    const balanceData = await balanceResult.json();
    expect(balanceData.MNT).toBe(500); // 500 –ú–æ–Ω–µ—Ç—É—Å –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    
    console.log(`üíé –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${balanceData.MNT} –ú–æ–Ω–µ—Ç—É—Å`);

    // ========================================
    // –≠–¢–ê–ü 5: –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï AI (5 –ó–ê–ü–†–û–°–û–í)
    // ========================================
    console.log('\nü§ñ –≠–¢–ê–ü 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AI —á–µ—Ä–µ–∑ —á–∞—Ç-—Å–µ—Ä–≤–∏—Å');

    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö AI –º–æ–¥–µ–ª–µ–π
    const modelsResult = await fetch('/api/ai/models', {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    const models = await modelsResult.json();
    
    // –í—ã–±–∏—Ä–∞–µ–º —Å–∞–º—É—é –¥–µ—à–µ–≤—É—é –º–æ–¥–µ–ª—å (–¥–ª—è —Ç–µ—Å—Ç–æ–≤)
    const cheapestModel = models.find(m => m.provider === 'openrouter' && m.cost <= 0.01);
    expect(cheapestModel).toBeDefined();
    
    console.log(`üéØ –í—ã–±—Ä–∞–Ω–∞ –º–æ–¥–µ–ª—å: ${cheapestModel.name} (${cheapestModel.cost} –∑–∞ –∑–∞–ø—Ä–æ—Å)`);

    // –î–µ–ª–∞–µ–º 5 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ AI (–ø–æ 100 –ú–æ–Ω–µ—Ç—É—Å –∫–∞–∂–¥—ã–π)
    for (let i = 1; i <= 5; i++) {
      console.log(`üîÑ AI –∑–∞–ø—Ä–æ—Å ${i}/5...`);
      
      const aiRequest = await fetch('/api/chat/send', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${authToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: cheapestModel.id,
          message: `–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å ${i}: –ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?`,
          userId: user1Id
        })
      });

      const aiResponse = await aiRequest.json();
      expect(aiResponse.success).toBe(true);
      expect(aiResponse.cost).toBe(100); // 100 –ú–æ–Ω–µ—Ç—É—Å –∑–∞ –∑–∞–ø—Ä–æ—Å
      
      console.log(`‚úÖ –ó–∞–ø—Ä–æ—Å ${i} –≤—ã–ø–æ–ª–Ω–µ–Ω, —Å—Ç–æ–∏–º–æ—Å—Ç—å: 100 –ú–æ–Ω–µ—Ç—É—Å`);
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ 5 –∑–∞–ø—Ä–æ—Å–æ–≤
    const balanceAfterAI = await fetch(`/api/billing/balance/${user1Id}`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });

    const balanceAfterAIData = await balanceAfterAI.json();
    expect(balanceAfterAIData.MNT).toBe(0); // 500 - (5 * 100) = 0
    
    console.log(`üí≥ –ë–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ AI –∑–∞–ø—Ä–æ—Å–æ–≤: ${balanceAfterAIData.MNT} –ú–æ–Ω–µ—Ç—É—Å`);

    // ========================================
    // –≠–¢–ê–ü 6: –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –ü–û–ü–û–õ–ù–ï–ù–ò–ò
    // ========================================
    console.log('\n‚ö†Ô∏è –≠–¢–ê–ü 6: –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è');

    // –ü–æ–ø—ã—Ç–∫–∞ —Å–¥–µ–ª–∞—Ç—å –µ—â–µ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –Ω—É–ª–µ–≤–æ–º –±–∞–ª–∞–Ω—Å–µ
    const failedAIRequest = await fetch('/api/chat/send', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: cheapestModel.id,
        message: '–ï—â–µ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å',
        userId: user1Id
      })
    });

    const failedResponse = await failedAIRequest.json();
    expect(failedResponse.success).toBe(false);
    expect(failedResponse.error).toBe('INSUFFICIENT_BALANCE');
    expect(failedResponse.message).toContain('–ø–æ–ø–æ–ª–Ω–∏—Ç—å —Å—á–µ—Ç');
    
    console.log('‚ùå –ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω–µ–Ω: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
    console.log('üí° –°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–æ–ø–æ–ª–Ω–∏—Ç—å —Å—á–µ—Ç –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ');

    // ========================================
    // –≠–¢–ê–ü 7: –ü–û–ö–£–ü–ö–ê 1000 –ú–û–ù–ï–¢–£–° –ß–ï–†–ï–ó –ÆMONEY
    // ========================================
    console.log('\nüí≥ –≠–¢–ê–ü 7: –ü–æ–∫—É–ø–∫–∞ 1000 –ú–æ–Ω–µ—Ç—É—Å —á–µ—Ä–µ–∑ –ÆMoney');

    const paymentRequest = await fetch('/api/billing/purchase', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        amount: 1000,
        currency: 'MNT',
        paymentMethod: 'yoomoney',
        userId: user1Id
      })
    });

    const paymentData = await paymentRequest.json();
    expect(paymentData.success).toBe(true);
    expect(paymentData.paymentUrl).toBeDefined();
    
    console.log('üîÑ –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ –ÆMoney');

    // –°–∏–º—É–ª–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂ (webhook –æ—Ç –ÆMoney)
    const webhookResult = await fetch('/api/webhooks/yoomoney', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        operation_id: paymentData.operationId,
        status: 'success',
        amount: 1000,
        currency: 'MNT',
        user_id: user1Id
      })
    });

    expect(webhookResult.ok).toBe(true);
    console.log('‚úÖ –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å
    const balanceAfterPayment = await fetch(`/api/billing/balance/${user1Id}`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });

    const balanceAfterPaymentData = await balanceAfterPayment.json();
    expect(balanceAfterPaymentData.MNT).toBe(1000);
    
    console.log(`üíé –ë–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: ${balanceAfterPaymentData.MNT} –ú–æ–Ω–µ—Ç—É—Å`);

    // ========================================
    // –≠–¢–ê–ü 8: –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ô AI –ó–ê–ü–†–û–°
    // ========================================
    console.log('\nü§ñ –≠–¢–ê–ü 8: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π AI –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è');

    const additionalAIRequest = await fetch('/api/chat/send', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: cheapestModel.id,
        message: '–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ! –¢–µ–ø–µ—Ä—å –º–æ–≥—É –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É.',
        userId: user1Id
      })
    });

    const additionalAIResponse = await additionalAIRequest.json();
    expect(additionalAIResponse.success).toBe(true);
    
    console.log('‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π AI –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ');

    // ========================================
    // –≠–¢–ê–ü 9: –†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –ü–†–û–ì–†–ê–ú–ú–ê
    // ========================================
    console.log('\nüéÅ –≠–¢–ê–ü 9: –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ');

    // –°–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ
    const referralInfoResult = await fetch(`/api/referral/info/${user1Id}`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });

    const referralInfo = await referralInfoResult.json();
    expect(referralInfo.canRefer).toBe(true);
    expect(referralInfo.bonusAmount).toBe(1000); // 1000 –ú–æ–Ω–µ—Ç—É—Å –∑–∞ –¥—Ä—É–≥–∞
    
    console.log('üí° –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å –¥—Ä—É–∑–µ–π');
    console.log(`üéÅ –ë–æ–Ω—É—Å –∑–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞: ${referralInfo.bonusAmount} –ú–æ–Ω–µ—Ç—É—Å`);

    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ—é —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
    const referralLinkResult = await fetch(`/api/referral/link/${user1Id}`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });

    const referralLinkData = await referralLinkResult.json();
    expect(referralLinkData.link).toBeDefined();
    
    const referralLink = referralLinkData.link;
    console.log(`üîó –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞: ${referralLink}`);

    // ========================================
    // –≠–¢–ê–ü 10: –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –î–†–£–ì–ê –ò –ü–û–õ–£–ß–ï–ù–ò–ï –ë–û–ù–£–°–ê
    // ========================================
    console.log('\nüë• –≠–¢–ê–ü 10: –î—Ä—É–≥ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ');

    const friendData = {
      name: '–ü–µ—Ç—Ä –ò–≤–∞–Ω–æ–≤',
      email: 'petr.ivanov@gmail.com',
      password: 'FriendPass123!',
      phone: '+79991234568',
      referralCode: referralLinkData.code
    };

    // –î—Ä—É–≥ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è
    const friendRegistration = await fetch('/api/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(friendData)
    });

    const friendRegData = await friendRegistration.json();
    expect(friendRegData.success).toBe(true);
    
    const friendId = friendRegData.user.id;
    console.log(`‚úÖ –î—Ä—É–≥ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${friendId}`);

    // –î—Ä—É–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç email (—Å–∏–º—É–ª–∏—Ä—É–µ–º)
    const friendVerifyResult = await fetch('/api/auth/verify-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: friendId,
        code: '654321'
      })
    });

    expect(friendVerifyResult.ok).toBe(true);
    console.log('‚úÖ Email –¥—Ä—É–≥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–µ—Ä–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∑–∞—á–∏—Å–ª–∏–ª–∏—Å—å 1000 –ú–æ–Ω–µ—Ç—É—Å
    const finalBalanceResult = await fetch(`/api/billing/balance/${user1Id}`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });

    const finalBalanceData = await finalBalanceResult.json();
    expect(finalBalanceData.MNT).toBe(1900); // 1000 - 100 (AI –∑–∞–ø—Ä–æ—Å) + 1000 (—Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å)
    
    console.log(`üéâ –§–∏–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: ${finalBalanceData.MNT} –ú–æ–Ω–µ—Ç—É—Å`);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥—Ä—É–≥ —Ç–æ–∂–µ –ø–æ–ª—É—á–∏–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –±–æ–Ω—É—Å
    const friendBalanceResult = await fetch(`/api/billing/balance/${friendId}`);
    const friendBalanceData = await friendBalanceResult.json();
    expect(friendBalanceData.MNT).toBe(500); // 500 –ú–æ–Ω–µ—Ç—É—Å –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    
    console.log(`üë• –ë–∞–ª–∞–Ω—Å –¥—Ä—É–≥–∞: ${friendBalanceData.MNT} –ú–æ–Ω–µ—Ç—É—Å`);

    // ========================================
    // –ò–¢–û–ì–ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
    // ========================================
    console.log('\nüèÜ –ò–¢–û–ì–ò –ü–û–õ–ù–û–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–û–ì–û –°–¶–ï–ù–ê–†–ò–Ø:');
    console.log('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º email');
    console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –±–æ–Ω—É—Å–∞ (500 –ú–æ–Ω–µ—Ç—É—Å)');
    console.log('‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AI (5 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ 100 –ú–æ–Ω–µ—Ç—É—Å)');
    console.log('‚úÖ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ –ÆMoney (1000 –ú–æ–Ω–µ—Ç—É—Å)');
    console.log('‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ (–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–≥–∞)');
    console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±–æ–Ω—É—Å–∞ (1000 –ú–æ–Ω–µ—Ç—É—Å)');
    console.log(`üíé –ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ${finalBalanceData.MNT} –ú–æ–Ω–µ—Ç—É—Å`);
    console.log('üéØ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ!');

    // –§–∏–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
    expect(finalBalanceData.MNT).toBeGreaterThan(1500); // –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 1500
    expect(friendBalanceData.MNT).toBe(500);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    const transactionsResult = await fetch(`/api/billing/transactions/${user1Id}`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    
    const transactions = await transactionsResult.json();
    expect(transactions.length).toBeGreaterThanOrEqual(7); // –ú–∏–Ω–∏–º—É–º 7 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    
    const transactionTypes = transactions.map(t => t.type);
    expect(transactionTypes).toContain('REGISTRATION_BONUS');
    expect(transactionTypes).toContain('AI_USAGE');
    expect(transactionTypes).toContain('PAYMENT');
    expect(transactionTypes).toContain('REFERRAL_BONUS');
    
    console.log('üìã –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
  });
});