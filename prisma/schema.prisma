// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  email     String   @unique
  password  String
  globalRole GlobalRole @default(BUSINESS)
  status    UserStatus @default(ACTIVE)
  
  // Subscription and limits
  subscriptionPlan String? @default("basic")
  limits          String? @default("{\"projects\":1,\"products\":2,\"aiTokens\":1000}") // JSON as string
  
  // Profile data
  profile   String?  @default("{\"name\":\"\",\"avatar\":\"\",\"bio\":\"\"}") // JSON as string
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownedProjects    Project[] @relation("ProjectOwner")
  ownedAccounts    Account[] @relation("UserOwnsAccounts")
  projectAccesses  ProjectAccess[]
  grantedAccesses  ProjectAccess[] @relation("GrantedAccess")
  accountMemberships AccountMembership[]
  media            Media[]

  @@map("users")
}

model Project {
  id          String      @id @default(cuid())
  name        String
  description String?
  slug        String      @unique  // Генерируется из названия
  
  // Domain settings - ключевое отличие от старой схемы
  domain       String?     // situs subdomain (example.situs.com)
  customDomain String?     // custom domain (example.com)
  isPublished  Boolean     @default(false)
  
  // Project-level settings (общие для всех продуктов)
  settings String? @default("{\"theme\":\"auto\",\"language\":\"ru\"}") // JSON as string
  theme    String? @default("{\"primaryColor\":\"#3B82F6\",\"secondaryColor\":\"#8B5CF6\"}") // JSON as string
  
  // Ownership and access
  ownerId   String
  accountId String?
  status    ProjectStatus @default(ACTIVE)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  owner     User   @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  account   Account? @relation(fields: [accountId], references: [id], onDelete: Cascade)
  products  Product[]
  accesses  ProjectAccess[]
  media     Media[]
  menuTypes MenuType[] // Универсальная система меню
  
  @@map("projects")
}

model ProjectAccess {
  id        String           @id @default(cuid())
  projectId String
  userId    String
  role      ProjectRole
  grantedBy String
  grantedAt DateTime         @default(now())
  
  // Relations
  project       Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  grantedByUser User    @relation("GrantedAccess", fields: [grantedBy], references: [id])
  
  @@unique([projectId, userId])
  @@map("project_accesses")
}

model Product {
  id          String      @id @default(cuid())
  name        String
  description String?
  type        ProductType
  status      ProductStatus @default(DRAFT)
  
  // URL structure within project
  subdomain    String?     // shop.domain.com
  pathPrefix   String?     // /shop, /blog
  
  // Product settings and pricing
  settings     String?     @default("{}") // JSON as string
  pricingPlan  String?     @default("basic")
  
  // Project relation
  projectId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  pages   Page[]
  categories Category[] // Для ECOMMERCE продуктов
  items   Item[]      // Для ECOMMERCE продуктов
  
  @@unique([projectId, name])
  @@map("products")
}

model Page {
  id          String     @id @default(cuid())
  title       String
  slug        String
  content     String?    // Redaktus content blocks as JSON string
  pageType    PageType   @default(PAGE)
  status      PageStatus @default(DRAFT)
  isHomePage  Boolean    @default(false)
  orderIndex  Int        @default(0)
  
  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?
  
  // Template and Layout
  template    String?
  layout      String?
  
  // Product relation
  productId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([productId, slug])
  @@map("pages")
}

/// Мульти-аккаунтная структура и роли
model Account {
  id        String      @id @default(cuid())
  name      String
  type      AccountType
  ownerId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner     User    @relation("UserOwnsAccounts", fields: [ownerId], references: [id], onDelete: Cascade)
  projects  Project[]
  members   AccountMembership[]
  // Связи агентство ↔ клиент
  clients   AgencyClient[] @relation("AgencyAsAgency")
  agencies  AgencyClient[] @relation("AgencyAsClient")

  @@map("accounts")
}

model AccountMembership {
  id        String       @id @default(cuid())
  accountId String
  userId    String
  role      AccountRole
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([accountId, userId])
  @@map("account_memberships")
}

model AgencyClient {
  id               String   @id @default(cuid())
  agencyAccountId  String
  clientAccountId  String
  createdAt        DateTime @default(now())

  agency  Account @relation("AgencyAsAgency", fields: [agencyAccountId], references: [id], onDelete: Cascade)
  client  Account @relation("AgencyAsClient", fields: [clientAccountId], references: [id], onDelete: Cascade)

  @@unique([agencyAccountId, clientAccountId])
  @@map("agency_clients")
}

model Media {
  id          String    @id @default(cuid())
  filename    String
  originalName String
  mimeType    String
  size        Int
  url         String
  thumbnailUrl String?
  
  // Metadata
  alt         String?
  title       String?
  description String?
  
  // Project relation
  projectId   String
  uploadedBy  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)
  
  @@map("media")
}

/// Shop/E-commerce модели
model Category {
  id          String   @id @default(cuid())
  name        String
  description String?
  slug        String   // SEO-friendly URL (как alias в MenuItem)
  alias       String   @default("")  // Дублируем slug для совместимости с menu-подобным API
  image       String?
  
  // Иерархия категорий (как в Joomla MenuItem)
  level       Int      @default(1)  // Добавляем level как в MenuItem
  parentId    String?
  parent      Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  
  // Настройки отображения (как в Joomla MenuItem)
  orderIndex  Int      @default(0)
  isActive    Boolean  @default(true)
  isPublished Boolean  @default(true)  // Добавляем isPublished как в MenuItem
  language    String   @default("*")   // Добавляем language как в MenuItem
  accessLevel AccessLevel @default(PUBLIC)  // Добавляем accessLevel как в MenuItem
  
  // Product relation - категории привязаны к продукту ECOMMERCE
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Relations
  items       Item[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([productId, slug])
  @@unique([productId, alias])  // Добавляем уникальность alias как в MenuItem
  @@map("categories")
}

model Item {
  id           String      @id @default(cuid())
  name         String
  description  String?
  slug         String
  
  // Цены и наличие
  price        Decimal     @default(0)
  comparePrice Decimal?    // Цена до скидки
  costPrice    Decimal?    // Себестоимость
  sku          String?     // Артикул
  barcode      String?     // Штрихкод
  
  // Инвентарь
  trackQuantity Boolean    @default(true)
  quantity     Int         @default(0)
  lowStockThreshold Int?   // Минимальный остаток
  
  // Контент
  images       String      @default("[]") // JSON массив URL изображений
  content      String?     // Описание товара (JSON блоки)
  
  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?
  
  // Настройки
  status       ItemStatus  @default(DRAFT)
  isDigital    Boolean     @default(false) // Цифровой товар
  weight       Decimal?    // Вес для доставки
  dimensions   String?     // Размеры (JSON)
  
  // Категория
  categoryId   String
  category     Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  // Product relation
  productId    String
  product      Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Настройки отображения
  orderIndex   Int         @default(0)
  isFeatured   Boolean     @default(false)
  
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  
  @@unique([productId, slug])
  @@map("items")
}

/// Универсальная система меню (по принципу Joomla)
model MenuType {
  id          String     @id @default(cuid())
  name        String     // "main", "footer", "sidebar"
  title       String     // "Главное меню"
  description String?
  isActive    Boolean    @default(true)
  
  // Привязка к проекту
  projectId   String
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // Relations
  items       MenuItem[]
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  @@unique([projectId, name])
  @@map("menu_types")
}

model MenuItem {
  id          String       @id @default(cuid())
  title       String       // "Каталог товаров"
  alias       String       // "catalog"
  type        MenuItemType @default(COMPONENT)
  
  // Иерархия (как в Joomla)
  level       Int          @default(1)
  parentId    String?
  parent      MenuItem?    @relation("MenuHierarchy", fields: [parentId], references: [id])
  children    MenuItem[]   @relation("MenuHierarchy")
  orderIndex  Int          @default(0)
  
  // Привязка к компоненту (универсальная как в Joomla)
  component   String?      // "Website", "Store", "Blog", "Landing"
  view        String?      // "page", "category", "item", "list"
  layout      String?      // "default", "blog", "grid", "form"
  targetId    String?      // pageId, categoryId, itemId
  externalUrl String?      // Для type = URL
  
  // Настройки отображения
  isPublished Boolean      @default(true)
  accessLevel AccessLevel  @default(PUBLIC)
  language    String       @default("*")  // "*", "ru-RU", "en-GB"
  
  // Параметры (JSON как в Joomla)
  parameters  String       @default("{}")  // menu_show, menu_image, css_class, etc.
  
  // SEO метаданные
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?
  
  // CSS и стили
  cssClass        String?
  menuImage       String?
  
  // Связи
  menuTypeId  String
  menuType    MenuType     @relation(fields: [menuTypeId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  @@unique([menuTypeId, alias])
  @@map("menu_items")
}

// Enums
enum GlobalRole {
  SUPER_ADMIN
  STAFF
  AGENCY
  BUSINESS
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
}

enum ProjectStatus {
  ACTIVE      // Активный проект
  SUSPENDED   // Приостановлен (неоплата)
  ARCHIVED    // Архивный
  DELETED     // Помечен к удалению
}

enum ProjectRole {
  OWNER       // Владелец проекта
  ADMIN       // Администратор проекта
  EDITOR      // Редактор контента
  VIEWER      // Только просмотр
}

enum AccountType {
  AGENCY
  BUSINESS
}

enum AccountRole {
  OWNER
  ADMIN
  MANAGER
  MEMBER
}

enum ProductType {
  WEBSITE     // Корпоративный сайт
  ECOMMERCE   // Интернет-магазин
  BLOG        // Блог
  LANDING     // Лендинг
  API         // API сервис
}

enum ProductStatus {
  DRAFT       // Черновик
  ACTIVE      // Активный
  ARCHIVED    // Архивный
  DELETED     // Помечен к удалению
}

enum PageType {
  HOME        // Главная страница
  PAGE        // Обычная страница
  POST        // Пост блога
  LANDING     // Лендинг
  PRODUCT     // Страница товара
  CATEGORY    // Страница категории
}

enum PageStatus {
  DRAFT       // Черновик
  PUBLISHED   // Опубликована
  SCHEDULED   // Запланирована к публикации
  ARCHIVED    // Архивная
  DELETED     // Помечена к удалению
}

enum ItemStatus {
  DRAFT       // Черновик
  ACTIVE      // Активный товар
  OUT_OF_STOCK // Нет в наличии
  DISCONTINUED // Снят с продажи
  ARCHIVED    // Архивный
}

enum MenuItemType {
  COMPONENT   // Ссылка на компонент
  SEPARATOR   // Разделитель
  HEADING     // Заголовок группы
  URL         // Внешняя ссылка
}

enum AccessLevel {
  PUBLIC      // Публичный доступ
  REGISTERED  // Зарегистрированные пользователи
  SPECIAL     // Специальный уровень
  CUSTOM      // Пользовательский уровень
}
