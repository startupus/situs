# ТЗ: Разделение публичного лендинга и административной панели (админка под `/admin`)

## Цель
Перенести административный интерфейс под префикс `/admin` и освободить корень `/` под публичный лендинг и авторизацию. Обеспечить корректные редиректы со старых ссылок и непрерывность работы.

## Обоснование
- Чёткое разделение публичного/SEO и административной части
- Отдельные политики безопасности (CSP), robots, cookie scope для админки
- Удобная навигация: `/` — лендинг, `/admin` — рабочая зона

## Термины и зона ответственности
- «Админка» — существующий React Router раздел (проектная навигация, страницы, меню, заказы, пользователи и т.д.).
- «Системный проект (лендинг)» — публичный сайт системы, реализован как обычный `Project` с флагом `isSystem=true` (или типом `SYSTEM`). Управляется теми же модулями (Pages, Menu, SEO, Theme).

---

## Требования к маршрутам (до/после)
- Было: все админ-маршруты с корня (`/projects`, `/orders`, `/users`, ...)
- Стало: все админ-маршруты под `/admin/*`
  - Примеры:
    - `/admin/projects`
    - `/admin/projects/:projectId`
    - `/admin/projects/:projectId/pages`
    - `/admin/projects/:projectId/menus`
    - `/admin/orders`, `/admin/users`, ...
  - Auth-страницы админки: `/admin/login`, `/admin/forgot-password`, `/admin/register`
- Корень `/` — публичный лендинг (пока stub)

## Объём работ
### 1) Frontend (React Router)
- Перенести существующую роутер-схему под префикс `/admin`:
  - В файле `src/components/situs/SitusApp.tsx`
    - Обернуть текущий layout/маршруты в `<Route path="admin/*"> ... </Route>`
    - Обновить все дочерние пути на префикс `/admin`
  - Добавить публичные маршруты на корне `/` (stub-лендинг + переадресация в `/admin/login` при клике на «Войти»)
  - Рендер публичного сайта: корень `/` должен резолвить активный проект:
    - Если запрошен корневой домен без маппинга — подставлять системный проект (`isSystem=true`)
    - Если маппинг домена указывает на проект — рендерить его публичные Pages/Menu/Theme
- Обновить все абсолютные ссылки внутри админки на префикс `/admin`:
  - Глобальный поиск по ссылкам типа `to="/projects` → `to="/admin/projects`
  - Навигация в сайдбаре/хедере, редиректы `navigate`, тестовые ссылки

### 2) Переадресации (SPA-уровень и хостинг)
- На уровне SPA (временная совместимость):
  - Добавить маршрут ловушки (catch-all):
    - `/projects/*` → 301/SPA-redirect на `/admin/projects/*`
    - `/orders/*`, `/users/*`, `/marketing/*`, и т.д.
- На уровне сервера/прокси (при деплое):
  - Правила 301 для старых путей на новые `/admin/*`
  - Rewrite для SPA: `/admin/*` → `index.html`

### 3) Авторизация / Cookies
- Страницы входа/регистрации админки: `/admin/login`, `/admin/register`, `/admin/forgot-password`
- Cookie/JWT scope: по возможности ограничить `Path=/admin` для админских cookie
- Обновить ссылки на редиректы после логина (в админке) на `/admin/projects`

### 4) Robots, мета и безопасность
- `public/robots.txt`: `Disallow: /admin`
- CSP: предусмотреть отдельные политики для страницы `/` и для `/admin/*` (этап 2)
 - Публичные и админские cookie: разделить по `Path` (публичные — `/`, админские — `/admin`)

### 5) Dev/Build конфигурация
- Vite dev server: убедиться, что history fallback работает для `/admin/*`
- Если используется `base`, оставить `/`, роутинг решать средствами React Router

### 6) UI/Навигация (в рамках переноса)
- Сайбар/хедер уже реализуют поведение внутри админки — пути должны быть с префиксом `/admin`
- Левый сайдбар «назад» опирается на `location.pathname` — работает без доработок после изменения префикса
 - В списке проектов в админке системный проект помечать как «Системный», выводить сверху (пин), быстрые ссылки: Страницы/Меню/SEO/Тема/Домен

### 7) Тестирование
- Ручная проверка основных сценариев:
  - Открытие: `/admin/projects`, `/admin/projects/:id`, `/admin/projects/:id/pages`, `/admin/users`
  - Переходы по сайдбару/хедеру, поиск, «+»
  - Авторизация на `/admin/login`
  - Редиректы со старых ссылок (`/projects/...` → `/admin/projects/...`)
- E2E smoke (минимум): 1–2 тест-кейса на навигацию/редиректы

### 8) Миграция (по шагам)
1. Закоммитить новый лендинг `/` (stub) и новый корневой маршрут `/admin/*`
2. Перенести админ-маршруты под `/admin/*`
3. Обновить ссылки/навигацию
4. Включить SPA-редиректы со старых путей
5. Обновить robots.txt
6. Пройти ручной чек-лист
7. Подготовить правила 301 на production
 8. Создать «Системный проект» (isSystem=true), перенести публичные страницы/меню/SEO в него
 9. Включить резолвер домена/хоста для определения активного проекта на публичной стороне

### 9) Откат (rollback)
- Вернуть точку входа админки на `/` и отключить редиректы 301

---

## Чек-лист (выполнить по пунктам)
- [ ] Создать публичный лендинг (stub) на `/` (кнопка «Войти» → `/admin/login`)
- [ ] В `SitusApp.tsx` добавить `<Route path="admin/*">` с существующим layout и всеми админ-маршрутами
- [ ] Перенести все админские пути под `/admin/*`
  - [ ] `/projects`, `/orders`, `/users`, `/marketing`, `/support`, `/section-settings` и др.
  - [ ] Вложенные пути проектов (`/projects/:projectId/...`) → `/admin/projects/:projectId/...`
- [ ] Обновить все абсолютные ссылки/`navigate` в коде на префикс `/admin`
- [ ] Добавить SPA-редиректы:
  - [ ] `/projects/*` → `/admin/projects/*`
  - [ ] `/orders/*`, `/users/*`, `/marketing/*` → `/admin/...`
- [ ] Вынести страницы логина/регистрации в `/admin/login`, `/admin/register`, `/admin/forgot-password`
- [ ] Ограничить cookie/JWT на Path=`/admin` (если применимо)
- [ ] Добавить в `public/robots.txt`: `Disallow: /admin`
- [ ] Проверить Vite history fallback для `/admin/*`
- [ ] Ручная проверка навигации админки на новых путях
- [ ] Добавить 1–2 e2e smoke теста на навигацию и редирект
- [ ] Подготовить на сервере 301 редиректы со старых путей на новые
 - [ ] Создать системный проект `isSystem=true` и подключить рендер публичного сайта через общие модули (Pages/Menu/SEO/Theme)
 - [ ] В списке проектов в админке отразить системный проект и быстрые ссылки управления

---

## Критерии приёмки
- Корень `/` отдаёт публичный лендинг (или заглушку)
- Вся админка доступна по `/admin/*`, все старые адреса автоматически ведут на новые
- Авторизация и навигация админки работают полностью на префиксе `/admin`
- Robots запрещает индексацию `/admin`
- Не сломан SPA‑роутинг при обновлении страницы на глубоком `/admin/*`

## Риски
- Пропущенные абсолютные ссылки без префикса `/admin`
- Отсутствие серверных 301 может ухудшить UX при открытии старых ссылок из закладок
- Внешние интеграции/SSO: требуется обновить `redirect_uri`

## Дальнейшие шаги
- Рассмотреть перенос админки на субдомен (например, `admin.example.com`) для максимальной изоляции (этап 2)
