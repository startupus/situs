## ТЗ: Навигация админки от компонента Меню и системный проект админки

### Цель
Сделать единый источник правды для навигации админки (левый сайдбар, верхняя панель, хлебные крошки) через существующий компонент управления меню. Ввести «системный проект админки», в котором хранится конфигурация навигации. Исключить хардкоды маршрутов и названий в UI.

### Обоснование
- **Единая конфигурация**: изменение структуры без релиза фронта
- **Права**: скрытие/показ пунктов по Permissions
- **Готовность к `/admin`**: совместимо с переносом админки под префикс (см. `docs/specs/admin-routing-tz.md`)
- **Консистентные крошки/титулы**: вычисляются на бэке в `/api/ui/meta`

### Термины
- **Системный проект админки**: проект со специальным флагом (например, `isSystemAdmin=true`, slug: `situs-admin`), неудаляемый.
- **Типы меню**:
  - `admin-sidebar` — левые иконки верхнего уровня админки
  - `admin-top` — быстрые действия/иконки верхней панели (опционально)
  - `project-sidebar` — (опционально) навигация внутри проекта

### Архитектура и объём работ
#### 1) Данные и БД
- Проект: добавить флаг `isSystemAdmin` (или использовать существующий `isSystem` с уточняющим типом) и сид `situs-admin`.
- Меню: использовать существующие `Menu`, `MenuItem`.
  - Поля: `title`, `icon`, `targetType` (`route|external|action`), `targetPath`, `permissionKeys[]`, `order`, `children[]`, `menuType`.
- Блокировать удаление системного проекта на уровне UI + проверка в API.

#### 2) API
- Меню:
  - `GET /api/menus/projects/:projectId?type=admin-sidebar` — древовидная структура сайдбара
  - `GET /api/menus/projects/:projectId?type=admin-top` — элементы верхней панели
- Метаданные верхней панели:
  - `GET /api/ui/meta?path=/projects/:id/...` → `{ title, breadcrumbs: [{label,to?}], activeMenuItemId? }`
  - Алгоритм: сопоставить `path` пунктам меню (поддержка `:projectId`, вложенности), построить крошки из родителей. Текущий лист не включать в крошки.
- SSE: при изменении меню отправлять событие для обновления UI (исп. существующий Realtime/SSE).

#### 3) Frontend
- `SitusSidebar`:
  - Рендерить список иконок из `admin-sidebar` системного проекта.
  - В проектном контексте: сохранить текущую 2/3‑уровневую модель; опционально источником сделать `project-sidebar`.
  - Поддержать `permissionKeys` — скрывать недоступные элементы.
- `SitusHeader`:
  - Полностью перейти на `/api/ui/meta` для заголовка/крошек.
  - Быстрые кнопки — из `admin-top` или `project-top` (опц.).
  - Крошки: показывать только родителей до текущего листа.
- `ActiveMenuTracker`:
  - Подсветка активного пункта и родителей по `path`.
  - Поддержка динамических сегментов (`:projectId`).

#### 4) Права и безопасность
- Каждый пункт меню может иметь `permissionKeys[]`; если прав нет — пункт скрывается.
- Фильтрация на бэке при выдаче меню + дублирующая проверка на фронте.

#### 5) Миграции/сиды
- Создать системный проект `situs-admin` (`isSystemAdmin=true`).
- Сид навигации:
  - `admin-sidebar`: Dashboard(`/`), Projects(`/projects`), Users(`/users`), Marketing(`/marketing`), Support(`/support`), Settings(`/section-settings`)
  - `admin-top`: быстрые иконки (опционально)
- Защитить критичные пункты правом `ADMIN_NAV_EDIT`.

#### 6) Интеграция с `/admin`
- После переноса админки под `/admin` обновить `targetPath` в меню (прозрачно для UI).

### UI/UX правила
- В крошках не отображать текущий раздел (лист). Только родителей.
- Активный раздел выделять; родители — путь.
- Fallback: если меню недоступно — использовать локальную логику, не ломая UX.

### Критерии приёмки
- Сайдбар и верхняя панель на страницах админки берут структуру из `admin-sidebar` / `admin-top`.
- На `/projects/:id/pages` и `/projects/:id/settings/*` заголовок и крошки корректны и не содержат текущий лист.
- Изменение меню через «Управление меню» обновляет UI без перезагрузки (SSE/рефетч).

### Миграция админ‑страниц в системный компонент ADMIN
1) Модель данных
- Продукт `ADMIN` в системном проекте `situs-admin` (Prisma `Product.type = ADMIN`).
- Экран `AdminScreen` с полями: `title`, `alias` (уникальный в проекте), `path` (абсолютный URL), `orderIndex`, `icon`, `category`, `projectId`, `productId`.

2) Бэкенд (NestJS)
- Модуль `admin-screens` (service/controller) с CRUD: list/get/upsert/remove.
- Эндпоинт `/api/ui/meta`:
  - Сначала ищет `AdminScreen` по `path` → возвращает `{title, breadcrumbs: []}`.
  - Если не найден — ищет соответствие в меню `admin-sidebar` системного проекта.
  - Для project‑контекста (`/projects/:slug/...`) работает текущая логика проекта.

3) Сидирование экранов
- Создать базовые экраны: `/projects`, `/users`, `/marketing`, `/support`.
- Сопоставить пункты `admin-sidebar` с соответствующими `AdminScreen.path`.

4) Перенос страниц админки
- Для каждой текущей страницы админки определить `path` и `title`.
- Создать/обновить запись `AdminScreen` с тем же `path` и нормализованным `title`.
- Удалить хардкод заголовков/крошек из фронтенд‑компонентов, использовать `/api/ui/meta`.
- Проверить, что пункт меню (если есть) ведёт на актуальный `path`.

5) Ограничения и безопасность
- Системный проект: нельзя удалить, нельзя статус `DELETED`, нельзя менять `slug` и `ownerId`.
- В UI: системный проект отображать с бейджем “system”, без кнопки удаления и без тумблера статуса.

6) Тестирование
- E2E (Playwright): для каждого перенесённого `AdminScreen` открыть `path` и проверить корректные заголовок/крошки.
- Проверить, что изменения меню/экранов отражаются в UI без перезагрузки (SSE/рефетч).

### Чек‑лист
- [ ] Создать системный проект `situs-admin` (флаг `isSystemAdmin=true`), сидом
- [ ] Посеять типы меню `admin-sidebar` и `admin-top` в `situs-admin`
- [ ] Добавить тип продукта `ADMIN` и модель `AdminScreen` (Prisma)
- [ ] Создать модуль `admin-screens` (NestJS) с CRUD: list/get/upsert/remove
- [ ] Сидировать базовые `AdminScreen`: `/projects`, `/users`, `/marketing`, `/support`
- [ ] `/api/ui/meta`: сначала `AdminScreen` по `path`, затем меню `admin-sidebar`; затем проектная логика
- [ ] Подключить `SitusSidebar` к `admin-sidebar`; `SitusHeader` к `/api/ui/meta`
- [ ] Показать системный проект в `/projects` с бейджем “system”; скрыть удаление и тумблер статуса
- [ ] Запретить на бэкенде: удаление системного проекта, статус `DELETED`, изменение `slug` и `ownerId`
- [ ] Перенести текущие админ‑страницы: для каждого маршрута создать `AdminScreen` с `path/title`; убрать локальные title/breadcrumbs
- [ ] Сопоставить пункты меню `admin-sidebar` с `AdminScreen.path` (router targets)
- [ ] Документировать стандарты экранов админки (title, breadcrumbs, permissions)
- [ ] E2E (Playwright): проверить заголовки/крошки для всех перенесённых экранов, обновления через SSE

### Риски
- Различия прав у ролей → исчезновение элементов; логирование и мониторинг.
- Ошибки сопоставления `path` ↔ шаблонов; покрыть тестами.
- Нагрузка на бэке при частых запросах — добавить кеширование.
