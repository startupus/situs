# Стандарты кодирования (адаптировано из Joomla для нашего стека)

[Полная структура стандартов и чеклисты находятся в `docs/coding-standards/`](./coding-standards/).

Документ описывает единые правила кодирования для проекта, вдохновлённые стандартами Joomla (`https://github.com/genr8r/coding-standards`) и адаптированные под наш стек: TypeScript/React (Vite) на фронтенде и NestJS (TypeScript) + Prisma/TypeORM на бэкенде. Этот документ дополняет `docs/DEVELOPMENT_STANDARDS.md` (процессы) и не дублирует их.

## Цели

- Консистентный и читаемый код во всех пакетах
- Предсказуемая архитектура модулей и файлов
- Минимум «магии», максимум явности типов и зависимостей
- Простота сопровождения, рефакторинга и тестирования

## Базовые принципы (по аналогии с Joomla)

- Читаемость важнее краткости. Предпочитаем явные имена и простые конструкции.
- Модули изолированы и общаются через чёткие интерфейсы (DI на бэке, props на фронте).
- Отделяем слои ответственности: контроллеры/сервисы/данные на бэке, компоненты/состояние/утилиты на фронте.
- Все публичные API документируем и покрываем тестами.

## Языки и форматирование

- TypeScript везде: `.ts` / `.tsx`.
- Отступ: 2 пробела. Строки: LF. Кодировка: UTF‑8.
- Всегда использовать строгие сравнения `===`/`!==`.
- Не использовать `var`. Предпочитать `const`, при необходимости `let`.
- Точка с запятой — обязательна.
- Максимальная длина строки — 120 символов (ориентир; допускается мягкое превышение для URL/строк).

Инструменты контроля:

- ESLint (см. `eslint.config.js`), запуск: `npm run lint` / `npm run lint:fix`.
- TypeScript строгий: см. `tsconfig.json`, `tsconfig.server.json`.

## Именование

- Классы/типы/enum: `PascalCase` (например, `User`, `UsersService`, `MenuItemParams`).
- Функции/переменные/пропсы: `camelCase` (например, `fetchMenuItems`, `isActive`).
- Константы: `UPPER_SNAKE_CASE` (например, `DEFAULT_PAGE_SIZE`).
- React‑компоненты: `PascalCase`, файл совпадает с именем компонента: `MenuItemsList.tsx` → `export function MenuItemsList() {}`.
- Хуки React: начинать с `use` (например, `useProjectMenu`).
- DTO интерфейсы: `PascalCase` с суффиксом `Dto` (например, `CreateUserDto`).
- Бэкенд сущности/файлы: файловые суффиксы NestJS — `.controller.ts`, `.service.ts`, `.module.ts`, `.entity.ts`, DTO — в `dto/`.
- Prisma модели: `PascalCase` (ед. число), поля — `camelCase`.

## Структура директорий

- Бэкенд `src/server/*` (NestJS): модульная структура по доменам
  - `users/users.module.ts`, `users/users.controller.ts`, `users/users.service.ts`, `users/entities/user.entity.ts`, `users/dto/*.ts`
  - Сервис — чистая бизнес‑логика; контроллер — только HTTP/валидация; доступ к данным — через сервис/репозиторий.
- Фронтенд `src/*`:
  - Компоненты: `src/components/...` (фичи/виджеты отдельными подпапками)
  - Типы: `src/types/*`, утилиты: `src/lib/*` или `src/utils/*`
  - Хуки: `src/hooks/*`
  - API‑клиенты: `src/api/services/*`

## Импорты и пути

- Использовать алиасы из `tsconfig.json`: `@/*`, `redaktus/*`, `website/*` и т.д.
- Порядок импортов: системные → внешние пакеты → внутренние модули → локальные файлы.
- Запрещены циклические зависимости. Предпочитать более высокоуровневые точки входа (index.ts) вместо глубоких относительных путей.

## Документация кода

- Для всех экспортируемых функций/классов — TSDoc‑комментарии `/** ... */` (назначение, параметры, возвращаемое значение, возможные ошибки).
- Публичные API бэкенда — Swagger‑метаданные через декораторы (`@ApiTags`, `@ApiProperty` и др.).
- В каждом значимом каталоге — `README.md` с назначением подпакета и точками входа.

Пример TSDoc:

```ts
/** Возвращает список пунктов меню по фильтрам */
export async function fetchMenuItems(filters: MenuItemFilters): Promise<MenuItem[]> {
  /* ... */
}
```

## Ошибки и исключения

- Бэкенд: использовать исключения NestJS (`BadRequestException`, `NotFoundException`, и т.п.). Не бросать «сырые» ошибки.
- Логирование — через централизованный логгер. Не оставлять `console.log` в коммитах (ESLint запрещает).
- Фронтенд: пользовательские ошибки отображать через единый механизм уведомлений/тостов; сетевые — с понятной деградацией.

## Валидация и типы

- В бэкенде использовать `class-validator`/`class-transformer` для DTO. Включать `whitelist`, `forbidNonWhitelisted`.
- Не использовать `any`, кроме обоснованных интеграций. Предпочитать точные типы или дженерики.
- В React пропсы компонентов типизировать интерфейсами `SomethingProps` и избегать `React.FC` для children‑неявности.

## React (UI) правила

- Компонент — одна ответственность. Разбивать большие компоненты на подкомпоненты.
- Стили — через Tailwind CSS, классы собирать `clsx`/`tailwind-merge`. Не дублировать «магические» классы.
- Состояние — локальное в компоненте, общие состояния — через `zustand` сторами с чистыми селекторами.
- Эффекты — чистые, с полным списком зависимостей. Асинхронные вызовы оборачивать в отменяемые/безопасные конструкции.
- Доступность: aria‑атрибуты, фокус‑менеджмент, клавиатурная навигация (особенно в меню/диалогах).

## NestJS (бэкенд) правила

- Модули оформлять по доменам. Никаких «god‑services».
- Контроллер — тонкий слой: маршрутизация + DTO + статус‑коды. Бизнес‑логика только в сервисах.
- Для данных использовать один источник правды: Prisma или TypeORM (в проекте присутствуют оба — придерживаться выбранного для модуля и не смешивать внутри одного контекста без необходимости).
- Интерфейсы и типы выносить в `src/types/*` при повторном использовании.
- Транзакции — через ORM‑механизм. Ошибки переводить в HTTP‑исключения.

## Меню и мультиязычность (Joomla‑like)

- Типы меню и пунктов меню — как в `src/types/menu.ts`. Иерархия — через родительские ссылки (бесконечная вложенность).
- Параметры пунктов — JSON‑настройки с явными типами. Языковые версии — не дублируют структуру, а конфигурируются вкладками/параметрами.
- Роутинг и lookup‑таблицы — централизованно в сервисах меню (`src/server/menus/*`).

## Тестирование

- Единый стандарт: Vitest для unit, Playwright — для e2e. Jest не использовать (см. `rules.md`).
- Покрывать: бизнес‑логику сервисов, критические утилиты, правила меню/роутинга.
- Размещение тестов: рядом с кодом (`*.test.ts`/`*.test.tsx`) или в `__tests__` для e2e/интеграционных.

## Коммиты и PR

- Рекомендуется Conventional Commits: `feat:`, `fix:`, `docs:`, `refactor:`, `test:`, `chore:`.
- Мелкие PR с понятным DIFF. Описание — что сделано, почему, как проверено.

## Локализация и строки

- Не хардкодить пользовательские тексты. Использовать `i18next` и единую схему ключей.
- Тексты интерфейса — из словарей, параметры форматировать явно.

## Лицензии и зависимости

- При добавлении зависимостей проводить лицензионный аудит (см. `rules.md`). Исключать пакеты с не‑совместимыми лицензиями.
- Периодически обновлять зависимости и фиксировать версии.

## Проверки перед мёрджем

- `npm run lint` — без ошибок.
- `tsc` — без ошибок (фронт и бэк).
- Тесты — зелёные (`npm run test`, `npm run test:e2e` по необходимости).
- Документация — обновлена (минимум README подпакета).

## Примеры соглашений (быстрая шпаргалка)

- Файл контроллера: `src/server/users/users.controller.ts`
- Файл сервиса: `src/server/users/users.service.ts`
- Файл энтити: `src/server/users/entities/user.entity.ts`
- DTO: `src/server/users/dto/create-user.dto.ts`
- Компонент: `src/components/admin/menu/MenuItemsList.tsx`
- Хук: `src/hooks/useProjectMenu.ts`
- Типы меню: `src/types/menu.ts`

---

Обновляйте документ при изменении архитектуры или инструментов. Источник вдохновения — стандарты Joomla, но истинный приоритет — текущая архитектура проекта и наш стек TypeScript/NestJS/React.
