# Система аутентификации

## Обзор

Система аутентификации Situs Platform предоставляет гибкие возможности входа, регистрации и восстановления доступа с поддержкой различных каналов связи.

## Методы аутентификации

### 1. Вход по паролю

**URL**: `/login`

**Особенности**:

- Поддержка входа через email или телефон
- Переключение между каналами связи через табы
- Интеграция с восстановлением пароля
- Ссылки на регистрацию и вход по коду

**Компонент**: `LoginPage.tsx`

### 2. Вход по коду

**URL**: `/login?method=code`

**Процесс**:

1. **Ввод контакта** - выбор email или телефона
2. **Подтверждение** - ввод 6-значного кода из сообщения

**Особенности**:

- Автоматическая отправка кода при заполнении контакта
- Таймер повторной отправки (60 секунд)
- Автоматическая проверка кода при заполнении
- Поддержка вставки кода из буфера обмена

**Компонент**: `CodeLogin.tsx`

## Восстановление пароля

**URL**: `/forgot-password`

**Многошаговый процесс**:

### Шаг 1: Выбор контакта

- Табы для выбора email или телефона
- Валидация введенных данных
- Отправка кода восстановления

### Шаг 2: Подтверждение по коду

- Ввод 6-значного кода
- Автоматический переход при заполнении
- Поддержка вставки из буфера

### Шаг 3: Новый пароль

- Создание нового пароля
- Подтверждение пароля
- Валидация совпадения

### Шаг 4: Завершение

- Подтверждение успешного изменения
- Переход к странице входа

**Компонент**: `ForgotPassword.tsx`

## Публичная регистрация

**URL**: `/register`

**Многошаговый процесс с прогресс-баром**:

### Шаг 1: Данные пользователя

- Ввод полного имени
- Выбор email или телефона через табы
- Валидация уникальности

### Шаг 2: Подтверждение по коду

- Отправка кода подтверждения
- Ввод 6-значного кода
- Автоматический переход

### Шаг 3: Создание пароля

- Ввод пароля
- Подтверждение пароля
- Валидация требований безопасности

### Шаг 4: Завершение

- Создание аккаунта
- Автоматический редирект на вход (5 сек)
- Кнопка ручного перехода

**Компонент**: `Register.tsx`

## Backend API

### Аутентификация

#### POST /api/auth/login

Вход по паролю

```json
{
  "email": "user@example.com", // или phone
  "password": "password123"
}
```

#### POST /api/auth/send-code

Отправка кода для входа

```json
{
  "email": "user@example.com", // или phone
  "channel": "EMAIL" // или SMS
}
```

#### POST /api/auth/verify-code

Вход по коду

```json
{
  "email": "user@example.com", // или phone
  "code": "123456"
}
```

### Восстановление пароля

#### POST /api/auth/forgot-password

Запрос кода восстановления

```json
{
  "email": "user@example.com", // или phone
  "channel": "EMAIL" // или SMS
}
```

#### POST /api/auth/reset-password

Сброс пароля по коду

```json
{
  "email": "user@example.com", // или phone
  "code": "123456",
  "newPassword": "newpassword123"
}
```

### Регистрация

#### POST /api/auth/register-public

Публичная регистрация

```json
{
  "name": "Иван Иванов",
  "email": "ivan@example.com", // или phone
  "password": "password123",
  "verificationCode": "123456"
}
```

## Компоненты UI

### VerificationCodeInput

Компонент для ввода кода подтверждения

**Особенности**:

- Поддержка вставки из буфера обмена
- Автоматическое заполнение всех полей
- Валидация длины кода
- Автоматический фокус между полями
- Обработка ошибок

**Использование**:

```tsx
<VerificationCodeInput
  length={6}
  value={code}
  onChange={handleCodeChange}
  onComplete={handleCodeComplete}
  error={error}
/>
```

## Безопасность

### Хеширование паролей

- Использование `bcryptjs` для хеширования
- Соль генерируется автоматически
- Минимальная длина пароля: 6 символов

### Коды подтверждения

- 6-значные числовые коды
- Время жизни: 10 минут
- Временное хранение в памяти (в продакшене - Redis)
- Одноразовое использование

### Валидация данных

- `class-validator` для DTO
- Проверка уникальности email/телефона
- Валидация формата email и телефона

## Маршрутизация

Все маршруты аутентификации настроены как публичные в `SitusApp.tsx`:

```tsx
{/* Публичные страницы (без layout) */}
<Route path="/login" element={<LoginPage />} />
<Route path="/forgot-password" element={<ForgotPassword />} />
<Route path="/register" element={<Register />} />
<Route path="/accept-invitation" element={<AcceptInvitation />} />
```

## Интеграция с системой связи

### CommunicationService

Централизованная отправка сообщений через различные каналы:

- EMAIL - отправка через email
- SMS - отправка через SMS (заглушка)
- TELEGRAM - через Telegram Bot (заглушка)
- WHATSAPP - через WhatsApp API (заглушка)
- SLACK - через Slack API (заглушка)

### Настройки каналов

Конфигурация каналов связи в глобальных настройках системы.

## Тестирование

### E2E тесты

Playwright тесты для проверки всех сценариев:

- `tests/e2e/accept-invitation.spec.ts` - тесты приглашений
- Покрытие всех шагов многошаговых процессов
- Тестирование валидации и обработки ошибок
- Проверка автоматических переходов

### Отладка

Для тестирования используется захардкоженный код `123456` в development режиме.

## Будущие улучшения

- [ ] Интеграция с реальными SMS провайдерами
- [ ] Двухфакторная аутентификация (2FA)
- [ ] OAuth интеграция (Google, GitHub, etc.)
- [ ] Биометрическая аутентификация
- [ ] Настройки безопасности пользователя
- [ ] Логирование попыток входа
- [ ] Блокировка по IP при множественных неудачных попытках
